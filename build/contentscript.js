// Generated by CoffeeScript 1.3.1
(function() {
  var SendImage, send_image;

  SendImage = (function() {

    SendImage.name = 'SendImage';

    SendImage.prototype.photo_url_test = /facebook.com\/photo.php/;

    function SendImage() {
      this.check_downloadlink();
      this.check_photo_url();
      this.watch_window();
    }

    SendImage.prototype.check_downloadlink = function() {
      return $('.fbPhotosPhotoActionsItem').each(function(i, el) {
        var href, this_el;
        this_el = $(el);
        href = null;
        if (this_el.attr('data-label') === "Download") {
          href = this_el.find('a').attr('href');
        } else if ($.trim(this_el.text()) === "Download") {
          href = this_el.attr('href');
        }
        if (href) {
          return chrome.extension.sendRequest({
            msg: 'facebook_image',
            href: href
          }, function(response) {});
        }
      });
    };

    SendImage.prototype.check_photo_url = function() {
      var last_url,
        _this = this;
      last_url = window.location.href;
      return this.fb_link_watch = setInterval(function() {
        var current_url;
        current_url = window.location.href;
        if (last_url !== current_url && _this.photo_url_test.test(current_url)) {
          _this.check_downloadlink();
          return last_url = current_url;
        }
      }, 500);
    };

    SendImage.prototype.watch_window = function() {
      var _this = this;
      $(window).on('blur', function() {
        return clearInterval(_this.fb_link_watch);
      });
      return $(window).on('focus', function() {
        return _this.check_photo_url();
      });
    };

    return SendImage;

  })();

  send_image = new SendImage();

}).call(this);

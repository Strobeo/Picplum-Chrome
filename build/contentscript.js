// Generated by CoffeeScript 1.3.1
(function() {
  var SendImage, send_image,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  SendImage = (function() {

    SendImage.name = 'SendImage';

    SendImage.prototype.photo_url_test = /facebook.com\/photo.php/;

    SendImage.prototype.fb_views_selectors = '.fbPhotoImage, .spotlight';

    SendImage.prototype.loader_template = '<div id="picplum_loading_wrap"><img src="https://s3.amazonaws.com/picplum-prod-assets/loader.gif"><div id="loading_inner"></div></div>';

    SendImage.prototype.fb_views = {
      fbPhotoImage: {
        name: 'photo_page',
        selectors: {
          img: '.fbPhotoImage',
          buttons_bar: '.stageButtons',
          insert_scope: '.tagButton'
        },
        insert: function(scope, html) {
          return $(html).insertAfter(scope);
        },
        templates: '<a class="picplum_send_action rfloat uiButton uiButtonOverlay" href="#" role="button" style="margin: 6px; background: #85638e;"><span style="color: white;" class="uiButtonText">Send to Picplum</span></a>'
      },
      spotlight: {
        selectors: {
          img: '.spotlight',
          buttons_bar: '.stageActions',
          insert_scope: '.bottomButtonsBar'
        },
        insert: function(scope, html) {
          return $(html).insertBefore(scope);
        },
        templates: '<a class="picplum_send_action buttonLink" rel="button" href="#">Send to Picplum</a><div class="separatorBorder"></div>'
      }
    };

    function SendImage() {
      this.watch_send_btn = __bind(this.watch_send_btn, this);

      this.add_fb_buttons = __bind(this.add_fb_buttons, this);

      var _this = this;
      this.check_downloadlink();
      this.check_photo_url();
      this.watch_window();
      this.insert_loader();
      chrome.extension.onRequest.addListener(function(request, sender) {
        console.log(request.msg);
        switch (request.msg) {
          case "loader_hide":
            return _this.loading({
              hide: true
            });
          case "loader_show":
            return _this.loading({
              msg: request.loader_msg
            });
          case 'loader_show_hide':
            return _this.loading({
              msg: request.loader_msg,
              autohide: true
            });
        }
      });
    }

    SendImage.prototype.check_downloadlink = function() {
      var _this = this;
      return $('.fbPhotosPhotoActionsItem').each(function(i, el) {
        var href, this_el;
        this_el = $(el);
        href = null;
        if (this_el.attr('data-label') === "Download") {
          href = this_el.find('a').attr('href');
        } else if ($.trim(this_el.text()) === "Download") {
          href = this_el.attr('href');
        }
        if (href) {
          chrome.extension.sendRequest({
            msg: 'facebook_image',
            href: href
          }, function(response) {
            return _this.loading({
              hide: true
            });
          });
          return _this.add_fb_buttons();
        }
      });
    };

    SendImage.prototype.check_photo_url = function() {
      var last_url,
        _this = this;
      last_url = window.location.href;
      return this.fb_link_watch = setInterval(function() {
        var current_url;
        current_url = window.location.href;
        if (last_url !== current_url && _this.photo_url_test.test(current_url)) {
          _this.check_downloadlink();
          return last_url = current_url;
        }
      }, 500);
    };

    SendImage.prototype.add_fb_buttons = function() {
      var _this = this;
      return $.each(this.fb_views, function(key, value) {
        if ($(value.selectors.img).length) {
          if (!$('.picplum_send_action').length) {
            value.insert(value.selectors.insert_scope, value.templates);
            return _this.watch_send_btn();
          }
        }
      });
    };

    SendImage.prototype.watch_window = function() {
      var _this = this;
      $(window).on('blur', function() {
        return clearInterval(_this.fb_link_watch);
      });
      return $(window).on('focus', function() {
        return _this.check_photo_url();
      });
    };

    SendImage.prototype.watch_send_btn = function() {
      var _this = this;
      return $('.picplum_send_action').on('click', function() {
        return chrome.extension.sendRequest({
          msg: 'send_button_click'
        }, function(response) {});
      });
    };

    SendImage.prototype.insert_loader = function() {
      $('body').append(this.loader_template);
      return $("#picplum_loading_wrap").click(function() {
        return $(this).hide();
      });
    };

    SendImage.prototype.get_image_meta = function() {
      return $(this.fb_views_selectors).offset();
    };

    SendImage.prototype.loading = function(arg) {
      var autohide, el, hide, image_meta, inner_el, msg, right_pos, top_pos, _ref, _ref1, _ref2;
      image_meta = this.get_image_meta();
      msg = (_ref = arg.msg) != null ? _ref : "Loading ...";
      hide = (_ref1 = arg.hide) != null ? _ref1 : false;
      autohide = (_ref2 = arg.autohide) != null ? _ref2 : false;
      el = $("#picplum_loading_wrap");
      inner_el = $("#loading_inner", el);
      top_pos = image_meta.top;
      right_pos = $(window).width() - (image_meta.width + image_meta.left);
      el.css({
        top: "" + (top_pos + 10) + "px",
        right: "" + (right_pos + 10) + "px"
      });
      if (hide) {
        return el.hide();
      } else {
        if (el.css("display") === 'none') {
          inner_el.html(msg);
          el.show();
        } else {
          if (msg !== inner_el.html()) {
            inner_el.html(msg);
          }
        }
        if (autohide) {
          return window.setTimeout(function() {
            return el.hide();
          }, 1500);
        }
      }
    };

    return SendImage;

  })();

  send_image = new SendImage();

}).call(this);

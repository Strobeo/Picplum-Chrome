// Generated by CoffeeScript 1.3.1
(function() {
  var PicplumSend, chrome_send;

  PicplumSend = (function() {

    PicplumSend.name = 'PicplumSend';

    PicplumSend.prototype.api_base = "https://www.picplum.com/api/1";

    PicplumSend.prototype.fb_url = 'www.facebook.com/photo.php';

    PicplumSend.prototype.download_url = null;

    function PicplumSend() {
      this.chrome_events();
      this.setup_context_menu();
    }

    PicplumSend.prototype.checkForValidUrl = function(tabId, changeInfo, tab) {
      if (tab.url.indexOf(this.fb_url > -1)) {
        return chrome.pageAction.show(tabId);
      }
    };

    PicplumSend.prototype.content_msg = function(request, sender, send_response) {
      chrome.pageAction.show(sender.tab.id);
      this.download_url = request.href;
      return send_response({});
    };

    PicplumSend.prototype.notify = function(args, timeout) {
      var noti;
      if (timeout == null) {
        timeout = 3500;
      }
      noti = webkitNotifications.createNotification(args.img, args.title, args.sub_title);
      noti.show();
      return window.setInterval(function() {
        return noti.cancel();
      }, timeout);
    };

    PicplumSend.prototype.getClickHandler = function() {
      var _this = this;
      return function(info, tab) {
        _this.download_url = info.srcUrl;
        return _this.add_photo(tab);
      };
    };

    PicplumSend.prototype.setup_context_menu = function() {
      return chrome.contextMenus.create({
        "title": "Send to Picplum",
        "type": "normal",
        "contexts": ["image"],
        "onclick": this.getClickHandler()
      });
    };

    PicplumSend.prototype.chrome_events = function() {
      chrome.tabs.onUpdated.addListener(this.checkForValidUrl);
      chrome.pageAction.onClicked.addListener(this.add_photo);
      return chrome.extension.onRequest.addListener(this.content_msg);
    };

    PicplumSend.prototype.add_photo = function(tab) {
      var post_image, thiz,
        _this = this;
      thiz = this;
      post_image = $.post("https://www.picplum.com/api/1/photos", {
        image_url: this.download_url,
        via: 'web'
      });
      post_image.success(function(data) {
        return thiz.notify({
          img: thiz.fb_url,
          title: 'Photo added to Picplum',
          sub_title: ''
        });
      });
      post_image.error(function(error_data, textStatus, errorThrown) {
        console.log(error_data);
        console.log(textStatus);
        console.log(errorThrown);
        if (error_data.status === 401) {
          thiz.notify({
            img: '',
            title: 'Please login to Picplum',
            sub_title: ''
          });
          return chrome.tabs.create({
            'url': 'https://www.picplum.com/login',
            'selected': true
          });
        }
      });
      return post_image.complete(function() {
        return console.log('complete');
      });
    };

    return PicplumSend;

  })();

  chrome_send = new PicplumSend();

}).call(this);
